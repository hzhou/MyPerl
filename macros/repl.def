
fncode: run_repl
    $include readline/readline.h
    $include readline/history.h
    $uselib readline

    $(set:type=parse_stack[i_stack_top-$1].type)
    $(set:value=parse_stack[i_stack_top-$1].value)
    i_stack_top = 0
    #- ref: scope.def -- compile_begin
    g_local.$grow 1
    g_local_len++
    stash_global = g_stashes[0]
    #- ref: main.def
    $call new_package, "::"
    #- ref: cv.def -- CV_begin
    stash_local = stash_new()

    $print
    $print "type \"quit\" to exit."
    $print
    $while 1
        s = readline("> ")
        $if !s || s $Eq "quit"
            return
        add_history(s)

        i_stack_top = perl_parse(s, NULL, parse_stack, i_stack_top)
        $if i_stack_top == 1 && $(type:1)==T_ATOM
            sv_ret = eval_op($(value:1).op,1,0)
            sv_str = do_string(sv_ret)
            $if sv_ret && sv_str
                &call with_sv_string, sv_str
                    $(s)[$(n)]='\0'
                    $print "  %s", $(s)
            $map ret_svreg, sv_ret, sv_str
            i_stack_top = 0
        $else
            $my struct TOK cur={0,0}
            dump_parse_stack(parse_stack, i_stack_top, cur, NULL)
            # $print [cont]

        f_commit_local_names()

